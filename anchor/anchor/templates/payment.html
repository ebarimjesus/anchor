
{% extends 'base.html' %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Purchase</title>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <!-- Include the Flutterwave React component if needed -->
    <script src="https://checkout.flutterwave.com/v3.js"></script>

    <!-- Add your styles here -->
    <style>
        /* Apply a reset to remove default browser styles */
        body, div, p, label, input, button {
            margin: 0;
            padding: 0;
            border: 0;
            outline: none;
            font-size: 100%;
            font-family: Arial, sans-serif;
            box-sizing: border-box;
        }

        body {
            background-color: #c06113;
        }

        .payment-container {
            max-width: 60%;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 15px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 50px;
            margin-bottom: 20px;
        }

        .payment-total-cost {
            margin-bottom: 20px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }

        .payment-total-cost p {
            margin: 15px 0;
        }

        label {
            display: inline-block;
            margin-right: 20px;
            font-weight: bold;
        }

        .payment-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .payment-button {
            display: block;
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .payment-button:hover {
            background-color: #0056b3;
        }

        #transaction-status {
            font-weight: bold;
            margin-top: 10px;
        }

        /* Radio buttons */
        input[type="radio"] {
            margin-right: 5px;
        }

        /* Currency display */
        #total-amount-ngn {
            color: #009933;
            font-weight: bold;
        }

        /* Add styles for token options */
        .token-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        /* Style the radio button labels */
        .token-option label {
            position: relative;
            padding-left: 40px; /* Adjust the padding as needed to create space for the image */
            font-weight: bold;
        }

        /* Style the token images */
        .token-option img {
            width: 20px; /* Adjust the width and height of the images as needed */
            height: 20px;
            margin-right: 10px; /* Adjust the margin as needed to create spacing between the image and label */
            border-radius: 50%; /* Make the images circular if desired */
            object-fit: cover; /* Ensure the image fits within the specified dimensions */
            position: absolute;
            transform: translateY(-50%);
        }
    </style>
</head>
<body>
    <h1>Token Purchase</h1>
    <div class="payment-container">
        <div class="payment-total-cost">
            <p>1 AFRO Token (XLM) = $<span id="afro-bid-price">0.00</span> (Buy Price), $<span id="afro-bid-price-usd">0.00</span> USD</p>
            <p>1 AFRO Token (XLM) = $<span id="afro-ask-price">0.00</span> (Sell Price), $<span id="afro-ask-price-usd">0.00</span> USD</p>
        </div>
        <div class="payment-total-cost">
            <p>1 OSO Token (XLM) = $<span id="oso-bid-price">0.00</span> (Buy Price), $<span id="oso-bid-price-usd">0.00</span> USD</p>
            <p>1 OSO Token (XLM) = $<span id="oso-ask-price">0.00</span> (Sell Price), $<span id="oso-ask-price-usd">0.00</span> USD</p>
        </div>
        <div class="payment-total-cost">
            <p>1 LIFE Token (XLM) = $<span id="life-bid-price">0.00</span> (Buy Price), $<span id="life-bid-price-usd">0.00</span> USD</p>
            <p>1 LIFE Token (XLM) = $<span id="life-ask-price">0.00</span> (Sell Price), $<span id="life-ask-price-usd">0.00</span> USD</p>
        </div>
        <div class="payment-total-cost">
            <p>1 NATURE Token (XLM) = $<span id="nature-bid-price">0.00</span> (Buy Price), $<span id="nature-bid-price-usd">0.00</span> USD</p>
            <p>1 NATURE Token (XLM) = $<span id="nature-ask-price">0.00</span> (Sell Price), $<span id="nature-ask-price-usd">0.00</span> USD</p>
        </div>

        <div class="token-option">
            <img id="afro-image" class="asset-image" src="https://res.cloudinary.com/dp7civtid/image/upload/v1692079822/AFRO_TOKEN_ndqlai.png" alt="AFRO Token Image">
            <label>
                <input type="radio" name="token-type" value="AFRO"> AFRO
            </label>
        </div>
        <div class="token-option">
            <img id="oso-image" class="asset-image" src="https://res.cloudinary.com/dp7civtid/image/upload/v1694304204/oso_nnfxeh.png" alt="OSO Token Image">
            <label>
                <input type="radio" name="token-type" value="OSO"> OSO
            </label>
        </div>
        <div class="token-option">
            <img id="life-image" class="asset-image" src="https://res.cloudinary.com/dp7civtid/image/upload/v1691841326/life-800x600_m22ylm.png" alt="LIFE Token Image">
            <label>
                <input type="radio" name="token-type" value="LIFE"> LIFE
            </label>
        </div>
        <div class="token-option">
            <img id="nature-image" class="asset-image" src="https://res.cloudinary.com/dp7civtid/image/upload/v1690650612/nature_pzqdla.png" alt="NATURE Token Image">
            <label>
                <input type="radio" name="token-type" value="NATURE"> NATURE
            </label>
        </div>

        <!-- User input fields -->
        <div class="payment-user-info">
            <label class="payment-label" for="user-name">Full Name:</label>
            <input class="payment-input" type="text" id="user-name" placeholder="Enter your full name" required>

            <label class="payment-label" for="user-email">Email Address:</label>
            <input class="payment-input" type="email" id="user-email" placeholder="Enter your email" required>

            <label class="payment-label" for="user-phone">Phone Number:</label>
            <input class="payment-input" type="tel" id="user-phone" placeholder="Enter your phone number" required>

            <label class="payment-label" for="user-wallet">Wallet or Federation Address:</label>
            <input class="payment-input" type="text" id="user-wallet" placeholder="Enter your wallet or federation address" required>

            <!-- Add more fields as needed, such as name, address, etc. -->

            <label class="payment-label" for="amount">Enter the number of tokens you want to purchase:</label>
            <input class="payment-input" type="number" id="amount" min="1" step="1" placeholder="Enter the amount" required>
            <input type="hidden" id="selected-asset" value="">
            <input type="hidden" id="paystack-amount" name="paystack-amount" value=""> <!-- Hidden input for Paystack amount -->
        </div>

        <!-- Total cost display -->
        <div class="payment-total-cost">
            <p>Total Amount in USD: $<span id="total-amount">0.00</span> </p>
            <p> <span id="total-amount-ngn">0.00</span> </p>
        </div>

        <!-- Payment method selection -->
        <div class="payment-method-selection">
            <label>
                <input type="radio" name="payment-method" value="paystack" checked> Pay with Paystack
            </label>
            <label>
                <input type="radio" name="payment-method" value="flutterwave"> Pay with Flutterwave
            </label>
        </div>

        <!-- Transaction status display -->
        <div class="payment-total-cost">
            <!-- Transaction status will be displayed here -->
            <p id="transaction-status"></p>
        </div>

        <!-- Payment buttons -->
        <!-- Pay with Paystack button -->
        <button class="payment-button" id="paystack-button">Pay with Paystack</button>

        <!-- Pay with Flutterwave button (added a new button) -->
        <button class="payment-button" id="flutterwave-button">Pay with Flutterwave</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/8.0.0/stellar-sdk.min.js"></script>
    <script>
        // Define Stellar server and assets for each token
        const server = new StellarSdk.Server('https://horizon.stellar.org');
        const tokenPairs = [
            { baseAssetCode: 'AFRO', counterAssetCode: 'XLM', issuerPublicKey: 'GBUYO263AYAZZKZI5ZCZFCPIGC42JVCGAOIP2CBBCUP2UTCEUIPIE2VV' },
            { baseAssetCode: 'OSO', counterAssetCode: 'XLM', issuerPublicKey: 'GAEESZVR52HUAHPOJZYWMWS7TYLSPS46IAK3ZDT7HTFBULDVOYUNEWCC' },
            { baseAssetCode: 'LIFE', counterAssetCode: 'XLM', issuerPublicKey: 'GBUYO263AYAZZKZI5ZCZFCPIGC42JVCGAOIP2CBBCUP2UTCEUIPIE2VV' },
            { baseAssetCode: 'NATURE', counterAssetCode: 'XLM', issuerPublicKey: 'GBUYO263AYAZZKZI5ZCZFCPIGC42JVCGAOIP2CBBCUP2UTCEUIPIE2VV' }
            // Add more tokens as needed
        ];

        // Function to fetch and display token prices
        function fetchTokenPrices(baseAssetCode) {
            // Find the corresponding token pair
            const pair = tokenPairs.find((pair) => pair.baseAssetCode === baseAssetCode);
            if (!pair) {
                console.error('Invalid token selected.');
                return;
            }

            const counterAssetCode = pair.counterAssetCode;
            const counterAssetIssuer = pair.counterAssetIssuer;

            // Create Stellar assets for both base and counter assets
            const baseAsset = new StellarSdk.Asset(pair.baseAssetCode, pair.issuerPublicKey);
            const counterAsset = new StellarSdk.Asset(pair.counterAssetCode, pair.counterAssetIssuer);

            server.orderbook(baseAsset, counterAsset)
                .call()
                .then((orderbook) => {
                    const bidPriceXLM = parseFloat(orderbook.bids[0].price);
                    const askPriceXLM = parseFloat(orderbook.asks[0].price);

                    // Use fixed rates for XLM/USD and USD/NGN conversions
                    const xlmToUsdRate = 0.124; // Replace with your fixed XLM/USD rate
                    const usdToNgnRate = 810; // Replace with your fixed USD/NGN rate

                    // Calculate the equivalent prices in USD
                    const bidPriceUSD = bidPriceXLM * xlmToUsdRate;
                    const askPriceUSD = askPriceXLM * xlmToUsdRate;

                    // Update the HTML elements with the retrieved XLM prices
                    document.getElementById(`${baseAssetCode.toLowerCase()}-bid-price`).textContent = `Bid Price (XLM): ${bidPriceXLM.toFixed(7)}`;
                    document.getElementById(`${baseAssetCode.toLowerCase()}-ask-price`).textContent = `Ask Price (XLM): ${askPriceXLM.toFixed(7)}`;

                    // Update the HTML elements with the equivalent USD prices
                    document.getElementById(`${baseAssetCode.toLowerCase()}-bid-price-usd`).textContent = `Bid Price (USD): $${bidPriceUSD.toFixed(2)}`;
                    document.getElementById(`${baseAssetCode.toLowerCase()}-ask-price-usd`).textContent = `Ask Price (USD): $${askPriceUSD.toFixed(2)}`;

                    // Update the total amount if a token amount is entered
                    const tokenAmount = parseFloat(document.getElementById("amount").value);
                    if (!isNaN(tokenAmount)) {
                        updateTotalAmount(baseAssetCode, tokenAmount, askPriceUSD, usdToNgnRate);
                    }
                })
                .catch((error) => {
                    console.error('Error fetching orderbook:', error);
                });
        }

        // Function to update the total amount
        function updateTotalAmount(baseAssetCode, tokenAmount, askPriceUSD, usdToNgnRate) {
            // Calculate the total amount in USD
            const totalAmountUSD = tokenAmount * askPriceUSD;

            // Calculate the total amount in NGN
            const totalAmountNGN = totalAmountUSD * usdToNgnRate;

            // Update the HTML element with the total amount
            document.getElementById("total-amount").textContent = totalAmountUSD.toFixed(2);
            document.getElementById("total-amount-ngn").textContent = `Total Amount in NGN: â‚¦${totalAmountNGN.toFixed(2)}`;

            // Update the hidden Paystack amount input
            document.getElementById("paystack-amount").value = totalAmountUSD.toFixed(2);
        }

        // Function to handle token type selection
        function handleTokenTypeSelection() {
            const selectedToken = document.querySelector('input[name="token-type"]:checked').value;
            document.getElementById("selected-asset").value = selectedToken;
            fetchTokenPrices(selectedToken);
        }

        // Add an event listener to the token type radio buttons
        const tokenTypeRadios = document.querySelectorAll('input[name="token-type"]');
        tokenTypeRadios.forEach((radio) => {
            radio.addEventListener("change", handleTokenTypeSelection);
        });

        // Add an event listener to the amount input
        const amountInput = document.getElementById("amount");
        amountInput.addEventListener("input", () => {
            const selectedToken = document.getElementById("selected-asset").value;
            const tokenAmount = parseFloat(amountInput.value);
            if (!isNaN(tokenAmount)) {
                fetchTokenPrices(selectedToken);
                const askPriceUSD = parseFloat(document.getElementById(`${selectedToken.toLowerCase()}-ask-price-usd`).textContent.split(":")[1].trim());
                const usdToNgnRate = 810; // Replace with your fixed USD/NGN rate
                updateTotalAmount(selectedToken, tokenAmount, askPriceUSD, usdToNgnRate);
            }
        });

        // Calculate and display initial token prices
        const initialSelectedToken = document.querySelector('input[name="token-type"]:checked').value;
        fetchTokenPrices(initialSelectedToken);
        handleTokenTypeSelection(); // Handle the initial selection
    </script>


<script>
   // Function to initialize the Flutterwave payment
function initializeFlutterwavePayment() {
    const selectedToken = document.querySelector('input[name="token-type"]:checked').value;
    const tokenAmount = parseFloat(document.getElementById("amount").value);
    const email = document.getElementById('user-email').value;
    const publicKey = "FLWPUBK_TEST-8a60b4e066d2ce99c1a68b8ab3e53401-X"; // Replace with your Flutterwave public key

    // Get the user's Stellar public key from the form
    const userPublicKey = document.getElementById('user-wallet').value;

    // Generate a unique reference including token type and token amount
    const reference = `PURCHASE_${userPublicKey}_${selectedToken}_${tokenAmount}_${Date.now()}`;

    const totalAmountUSD = parseFloat(document.getElementById("total-amount").textContent);
    const usdToNgnRate = 810; // Replace with your fixed USD/NGN rate
    const amountInKobo = Math.round(totalAmountUSD * usdToNgnRate);

    // Define your Flutterwave configuration here
    const config = {
        // Other configuration options...
        public_key: publicKey,
        tx_ref: reference,
        amount: amountInKobo, // Use the calculated amount in kobo
        currency: "NGN", // Use the appropriate currency code
        redirect_url: "", // Specify your redirect URL
        payment_type: "card, banktransfer, mobilemoneyghana, mobilemoneyfranco, barter, nqr, account, credit, ussd, barter",
        customer: {
            email: email,
        },
        callback: function (response) {
            // Handle the Flutterwave callback response here
            // Send the payment response to the backend for processing
            fetch('/flutterwave_payment_callback/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(response),
            })
            .then((response) => response.json())
            .then((data) => {
                // Handle the backend response, which can include a success message
                if (data.status === 'success') {
                    document.getElementById('transaction-status').textContent = "Payment successful!";
                } else {
                    document.getElementById('transaction-status').textContent = "Payment failed or was canceled.";
                }
            })
            .catch((error) => {
                console.error('Error sending Flutterwave payment response to the backend:', error);
            });
        },
        onClose: function () {
            // Handle the case where the Flutterwave dialog is closed
            document.getElementById('transaction-status').textContent = "Payment dialog closed.";
        },
    };

    // Initialize the Flutterwave payment
    FlutterwaveCheckout(config);
}

// Add an event listener for the Flutterwave payment button
const flutterwaveButton = document.getElementById("flutterwave-button");
flutterwaveButton.addEventListener("click", initializeFlutterwavePayment);
</script> 

<script>
    // Function to initialize the Paystack payment
    function initializePaystackPayment() {
        const selectedToken = document.querySelector('input[name="token-type"]:checked').value;
        const tokenAmount = parseFloat(document.getElementById("amount").value);
        const email = document.getElementById('user-email').value;
        const publicKey = "pk_test_934eca836db70269df56bd3bbe80ce33476f94a1"; // Replace with your Paystack public key

        // Get the user's Stellar public key from the form
        const userPublicKey = document.getElementById('user-wallet').value;

        // Generate a unique reference using the user's Stellar public key
        const reference = `PURCHASE_${userPublicKey}_${Date.now()}`;

        const totalAmountUSD = parseFloat(document.getElementById("total-amount").textContent);
        const usdToNgnRate = 810; // Replace with your fixed USD/NGN rate
        const amountInKobo = Math.round(totalAmountUSD * usdToNgnRate * 100 + 2600);


        // Create the Paystack handler
        var handler = PaystackPop.setup({
            key: publicKey,
            email: email,
            amount: amountInKobo, // Use the calculated amount in kobo
            currency: "NGN", // Use the appropriate currency code
            ref: reference, // Pass the unique reference here
            metadata: {
                custom_fields: [
                    {
                        display_name: "Token Type",
                        variable_name: "token_type",
                        value: selectedToken,
                    },
                    {
                        display_name: "Token Amount",
                        variable_name: "token_amount",
                        value: tokenAmount.toString(), // Convert token amount to string
                    },
                ],
            },
            callback: function (response) {
                // Handle the Paystack callback response
                // Send the payment response to the backend for processing
                fetch('{% url 'paystack_payment_callback' %}', { // Adjust the URL to match your Django endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(response),
                })
                .then((response) => response.json())
                .then((data) => {
                    // Handle the backend response, which can include a success message
                    if (data.status === 'success') {
                        document.getElementById('transaction-status').textContent = "Payment successful!";
                    } else {
                        document.getElementById('transaction-status').textContent = "Payment failed or was canceled.";
                    }
                })
                .catch((error) => {
                    console.error('Error sending Paystack payment response to the backend:', error);
                });
            },
            onClose: function () {
                // Handle the case where the Paystack dialog is closed
                document.getElementById('transaction-status').textContent = "Payment dialog closed.";
            },
        });

        // Open the Paystack payment dialog
        handler.openIframe();
    }

    // Add an event listener for the payment button
    const paymentButton = document.getElementById("paystack-button"); // Change to your Paystack button ID
    paymentButton.addEventListener("click", initializePaystackPayment);
</script>



</body>
{% endblock %}
